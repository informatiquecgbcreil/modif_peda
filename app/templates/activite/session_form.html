{% extends 'layout.html' %}

{% block body %}
  <div class="stack">
    <div class="card">
      <h1 style="margin-top:0;">Nouvelle session · {{ atelier.nom }}</h1>
      <form method="get" class="inline" style="gap:8px;">
        <input type="hidden" name="atelier_id" value="{{ atelier.id }}">
        <label>Projet (pour filtrer les modules autorisés)</label>
        <select class="in" name="projet_id" onchange="this.form.submit()">
          <option value="">Tous les projets liés</option>
          {% for p in projets_atelier|default([]) %}
            <option value="{{ p.id }}" {% if projet_id == p.id %}selected{% endif %}>{{ p.nom }}</option>
          {% endfor %}
        </select>
      </form>

      <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        {% if atelier.type_atelier == 'INDIVIDUEL_MENSUEL' %}
          <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:12px;">
            <div><label>Date RDV</label><input class="in" type="date" name="rdv_date" required></div>
            <div><label>Heure début</label><input class="in" type="text" name="rdv_debut" placeholder="09:00"></div>
            <div><label>Heure fin</label><input class="in" type="text" name="rdv_fin" placeholder="09:45"></div>
          </div>
        {% else %}
          <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr; gap:12px;">
            <div><label>Date session</label><input class="in" type="date" name="date_session" required></div>
            <div><label>Heure début</label><input class="in" type="text" name="heure_debut" placeholder="14:00"></div>
            <div><label>Heure fin</label><input class="in" type="text" name="heure_fin" placeholder="16:00"></div>
            <div><label>Capacité</label><input class="in" type="number" name="capacite" value="{{ atelier.capacite_defaut or '' }}" min="0"></div>
          </div>
        {% endif %}

        <div class="spacer"></div>
        <label>Module(s) de session (obligatoire)</label>
        <select class="in" name="module_ids" multiple size="8" required>
          {% for mod in modules|default([]) %}
            <option value="{{ mod.id }}">{{ mod.nom }} ({{ mod.competences|length }} compétences)</option>
          {% else %}
            <option disabled>Aucun module autorisé pour cet atelier/projet</option>
          {% endfor %}
        </select>
        <div class="muted">Le terrain ne sélectionne plus les compétences manuellement : elles sont déduites automatiquement des modules.</div>

        <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn" type="submit">Créer</button>
          <a class="btn" href="{{ url_for('activite.sessions', atelier_id=atelier.id) }}">Annuler</a>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
