{% extends 'layout.html' %}

{% block body %}
  <div class="stack">
    <div class="card">
      <h1 style="margin-top:0;">Objectifs pÃ©dagogiques (assistant)</h1>
      <p class="muted">Flux simple : 1) choisir type, 2) renseigner le minimum, 3) crÃ©er. Les options avancÃ©es restent cachÃ©es.</p>
      <div style="margin-bottom:10px;" class="row">
        <a class="btn" href="{{ url_for('pedagogie.modules_pedagogiques') }}">ðŸ“¦ Catalogue modules</a>
        <a class="btn" href="{{ url_for('pedagogie.plan_projet') }}">ðŸ§© Plan de projet</a>
        <a class="btn" href="{{ url_for('pedagogie.pilotage_objectifs') }}">ðŸ“ˆ Pilotage RA</a>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">CrÃ©er un objectif</h2>
      <form method="post" class="stack" id="objectifForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="create_objectif">

        <div>
          <label>Ã‰tape 1 Â· Type d'objectif</label>
          <select class="in" name="type" id="objType" required>
            <option value="">Choisirâ€¦</option>
            <option value="general">Objectif gÃ©nÃ©ral (OG)</option>
            <option value="specifique">Objectif spÃ©cifique (OS)</option>
            <option value="operationnel">Objectif opÃ©rationnel (OO)</option>
          </select>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label>Ã‰tape 2 Â· Titre</label>
            <input class="in" name="titre" required>
          </div>
          <div>
            <label>Seuil (%)</label>
            <input class="in" type="number" name="seuil_validation" min="0" max="100" step="1" value="60">
          </div>
        </div>

        <div id="fieldProjet" style="display:none;">
          <label>Projet (obligatoire pour OG)</label>
          <select class="in" name="projet_id">
            <option value="">â€”</option>
            {% for p in projets %}
              <option value="{{ p.id }}">{{ p.secteur }} Â· {{ p.nom }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="fieldAtelier" style="display:none;">
          <label>Atelier (obligatoire pour OS)</label>
          <select class="in" name="atelier_id">
            <option value="">â€”</option>
            {% for a in ateliers %}
              <option value="{{ a.id }}">{{ a.secteur }} Â· {{ a.nom }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="fieldModule" style="display:none;">
          <label>Module pÃ©dagogique (obligatoire pour OO)</label>
          <select class="in" name="module_id">
            <option value="">â€”</option>
            {% for m in modules %}
              <option value="{{ m.id }}">{{ m.nom }}</option>
            {% endfor %}
          </select>
          <div class="muted">Les compÃ©tences d'un OO sont dÃ©duites automatiquement du module.</div>
        </div>

        <details>
          <summary>Options avancÃ©es</summary>
          <label>Description</label>
          <textarea class="in" name="description" rows="2"></textarea>
          <label>Objectif parent (si connu)</label>
          <select class="in" name="parent_id">
            <option value="">Aucun</option>
            {% for obj in parent_options %}
              <option value="{{ obj.id }}">{{ obj.titre }} ({{ obj.type }})</option>
            {% endfor %}
          </select>
        </details>

        <button class="btn ok" type="submit">CrÃ©er l'objectif</button>
      </form>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">Objectifs existants</h2>
      <div class="tablewrap">
        <table>
          <thead><tr><th>Type</th><th>Titre</th><th>Projet/Atelier/Module</th><th>Parent</th><th></th></tr></thead>
          <tbody>
            {% for obj in objectifs %}
              <tr>
                <td><span class="badge">{{ obj.type }}</span></td>
                <td><strong>{{ obj.titre }}</strong></td>
                <td class="muted">
                  {% if obj.projet %}Projet : {{ obj.projet.nom }}<br>{% endif %}
                  {% if obj.atelier %}Atelier : {{ obj.atelier.nom }}<br>{% endif %}
                  {% if obj.module %}Module : {{ obj.module.nom }}{% endif %}
                </td>
                <td>{{ obj.parent.titre if obj.parent else 'â€”' }}</td>
                <td>
                  <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="delete_objectif">
                    <input type="hidden" name="objectif_id" value="{{ obj.id }}">
                    <button class="btn danger" type="submit">Supprimer</button>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="muted">Aucun objectif.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const typeSel = document.getElementById('objType');
      const p = document.getElementById('fieldProjet');
      const a = document.getElementById('fieldAtelier');
      const m = document.getElementById('fieldModule');
      function refresh() {
        const t = typeSel.value;
        p.style.display = t === 'general' ? 'block' : 'none';
        a.style.display = t === 'specifique' ? 'block' : 'none';
        m.style.display = t === 'operationnel' ? 'block' : 'none';
      }
      typeSel.addEventListener('change', refresh);
      refresh();
    })();
  </script>
{% endblock %}
