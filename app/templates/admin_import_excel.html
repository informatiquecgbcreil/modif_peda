
{% extends "layout.html" %}
{% block body %}
<div class="card">
  <h2>Import Excel ¬∑ pr√©sences</h2>
  <p class="muted">
    Tu balances ton fichier .xlsx et l'app va cr√©er (si besoin) les ateliers, sessions (par date) et pr√©sences.
    <br>‚ö†Ô∏è Ce format ne contient pas les horaires ‚Üí les sessions import√©es seront "date-only".
  </p>

  <form method="post" enctype="multipart/form-data" class="row" style="gap:12px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row" style="gap:10px; flex-wrap:wrap;">
      <div>
        <label class="muted">Secteur</label><br>
        <input class="input" type="text" name="secteur" value="{{ secteur or 'NUMERIQUE' }}" style="min-width:220px;">
      </div>

      <div>
        <label class="muted">Fichier Excel (.xlsx)</label><br>
        <input class="input" type="file" name="xlsx_file" accept=".xlsx" required>
      </div>

      <div style="display:flex; align-items:flex-end;">
        <label class="muted">Mode</label><br>
		<select class="input" name="dry_run" style="min-width:260px;">
		  <option value="1" {% if dry_run %}selected{% endif %}>Dry-run (test, rien n'est enregistr√©)</option>
		  <option value="0" {% if not dry_run %}selected{% endif %}>Import r√©el (√©crit en base)</option>
		</select>
      </div>

      <div style="display:flex; align-items:flex-end;">
        <button class="btn" type="submit">Importer üöÄ</button>
      </div>
    </div>
  </form>
</div>

{% if stats %}
<div class="card" style="margin-top:14px;">
  <h3>R√©sultat</h3>

  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
    <div class="pill">Onglets trait√©s: <b>{{ stats.sheets_processed }}</b></div>
    <div class="pill">Participants cr√©√©s: <b>{{ stats.participants_created }}</b></div>
    <div class="pill">Sessions cr√©√©es: <b>{{ stats.sessions_created }}</b></div>
    <div class="pill">Pr√©sences cr√©√©es: <b>{{ stats.presences_created }}</b></div>
    <div class="pill">Doublons ignor√©s: <b>{{ stats.presences_skipped_duplicates }}</b></div>
  </div>

  {% if stats.warnings and stats.warnings|length %}
  <div class="card" style="margin-top:12px; border-color: rgba(255,204,102,.35);">
    <h4>Warnings</h4>
    <ul>
      {% for w in stats.warnings %}
        <li>{{ w }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <details style="margin-top:12px;">
    <summary class="pill">D√©tails par onglet</summary>
    <div style="margin-top:10px;">
      {% for k, s in stats.sheets.items() %}
        <div class="card" style="margin:10px 0;">
          <h4 style="margin:0 0 6px 0;">{{ k }}</h4>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:8px;">
            <div class="pill">Lignes participants: <b>{{ s.participants }}</b></div>
            <div class="pill">Sessions (cr√©√©es): <b>{{ s.sessions }}</b></div>
            <div class="pill">Pr√©sences (cr√©√©es): <b>{{ s.presences }}</b></div>
          </div>

          {% if s.warnings and s.warnings|length %}
          <div style="margin-top:8px;">
            <b>Warnings:</b>
            <ul>
              {% for w in s.warnings %}
                <li>{{ w }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </details>
</div>
{% endif %}

{% endblock %}
